# Get list of staged files using null-delimited format for safety
# This prevents command injection via malicious filenames
has_files=false

git diff --cached --name-only -z --diff-filter=ACM | \
  grep -zE '\.(js|jsx|ts|tsx|json|css|scss|md)$' | \
  while IFS= read -r -d '' file; do
    has_files=true
    break
  done

if [ "$has_files" = true ]; then
  echo "Running Prettier on staged files..."

  # Process each file safely with proper quoting
  git diff --cached --name-only -z --diff-filter=ACM | \
    grep -zE '\.(js|jsx|ts|tsx|json|css|scss|md)$' | \
    while IFS= read -r -d '' file; do
      if ! npx prettier --write "$file"; then
        echo "Prettier formatting failed on: $file"
        exit 1
      fi
      git add "$file"
    done

  if [ $? -eq 0 ]; then
    echo "Prettier formatting applied to staged files."
  else
    echo "Prettier formatting failed. Please fix errors and try again."
    exit 1
  fi
fi
